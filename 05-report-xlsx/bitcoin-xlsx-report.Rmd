---
title: "Bitcoin Exchange Rates"
output: 
  html_document:
    theme: null
    highlight: null
    css: modest.css
params:
  code:
    label: "Code:"
    value: USD
    input: select
    choices: [USD, JPY, CNY, SGD, HKD, CAD, NZD, 
              AUD, CLP, GBP, DKK, SEK, ISK, CHF, 
              BRL, EUR, RUB, PLN, THB, KRW, TWD]
  start:
    label: "Start:"
    value: !r Sys.Date() - 3
    input: date
  end:
    label: "End:"
    value: !r Sys.Date()
    input: date

---

Bitcoin is a cryptocurrency and worldwide payment system. It is the first decentralized digital currency, as the system works without a central bank or single administrator. The network is peer-to-peer and transactions take place between users directly, without an intermediary. These transactions are verified by network nodes through the use of cryptography and recorded in a public distributed ledger called a blockchain.

```{r echo=FALSE, fig.height=3, fig.width=8, message=FALSE}
library(DBI)
library(dygraphs)
library(xts)
library(dplyr)
library(dbplyr)
library(openxlsx)

current_time <- Sys.time()

# Connect
con <- dbConnect(odbc::odbc(), "Postgres (DSN)")
bitcoin <- tbl(con, "bitcoin")

# Tidy
if(params$start > params$end) stop("Start must occur before end")
start <- params$start
end <- params$end + 1
dat <- bitcoin %>%
  filter(name == params$code) %>%
  filter(timestamp > start & timestamp <= end) %>%
  select(timestamp, last, symbol) %>%
  collect
tseries <- xts(dat$last, dat$timestamp)
lab <- paste0("Bitcoin (", dat$symbol[1], ")")

# Visualize
dygraph(tseries, main = lab) %>%
  dyOptions(axisLineWidth = 1.5, 
            fillGraph = TRUE, 
            drawGrid = FALSE, 
            colors = "steelblue", 
            axisLineColor = "darkgrey", 
            axisLabelFontSize = 15) %>%
  dyRangeSelector(fillColor = "lightsteelblue", strokeColor = "white")
```  

```{r build-model, echo=FALSE}
bitcoin_model <- glm(last ~ timestamp, dat, family = gaussian())

predicted_current <- predict(bitcoin_model, newdata = tibble(timestamp = current_time))[[1]]
predicted_tomorrow <- predict(bitcoin_model, newdata = tibble(timestamp = current_time + lubridate::days(1)))

predicted_diff <- predicted_tomorrow - predicted_current

currency <- dat$symbol[1]

if (predicted_diff > 0) {
  recommend <- "BUY"
  reason <- "THE HYPE"
  change_txt <- paste0("GAIN ", currency, " ", format(round(abs(predicted_diff), 2), nsmall = 2))
} else {
  # but really... who sells?
  recommend <- "SELL"
  reason <- "IT IS WORTHLESS"
  change_txt <- paste0("LOSE ", currency, " ", format(round(abs(predicted_diff),2), nsmall=2))
}

```


```{r build-xlsx, echo=FALSE}
wb <- loadWorkbook("./report-template.xlsx")
writeData(wb, "data", dat)

report_name <- paste0("bitcoin-report"
                      , format(current_time, format="%Y%m%d-%H%M%S")
                      ,".xlsx")
saveWorkbook(wb, report_name)
rmarkdown::output_metadata$set("rsc_output_files" = list(report_name))
list_of_attachments <- list(report_name)
rmarkdown::output_metadata$set("rsc_email_attachments" = list_of_attachments)

```

```{r build-email, echo=FALSE}

# set subject
rmarkdown::output_metadata$set("rsc_email_subject" = paste0(recommend, " Bitcoin!!  See attached: ",report_name))

# set plaintext email body
rmarkdown::output_metadata$set("rsc_email_body_text" = paste0(
"Hello,

This message is to inform you that you should ", recommend, " bitcoin.  
Why, you ask?  That's simple.

Because ", reason, "!!

Really.  By tomorrow, I predict you will ", change_txt, ".")
)

# build rich output 

``` 

I have to be honest.  I recommend that you **`r recommend`** bitcoin!  Why?  Because **`r reason`**!  For instance, by tomorrow, I predict you will `r change_txt`.

[Link to Excel Report](`r report_name`)
***

*Report as of: `r as.character(max(dat$timestamp))`. See [blockchain.info](https://blockchain.info/api/exchange_rates_api) for data source. CSS is borrowed from [here](http://markdowncss.github.io/modest/). For more information on R Markdown see [rmarkdown.com](http://rmarkdown.rstudio.com/).*
